<html>
    <head>
        <script src="/js/require.js"></script>
        <style>
            #edits {
                width: 24%;
                position: absolute;
                height: 100%;
                top: 0;
                left: 0;
                border-right: 1px solid black;
                overflow: auto;
            }
            #edit-target {
                position: absolute;
                top: 0;
                left: 24%;
                width: 75%;
                height: 100%;
                padding-left: 10px;
            }
        </style>
        <title>test - playback</title>
    </head>
    <body>
        <div id="edits">
            <ul></ul>
        </div>
        <div id="edit-target" contenteditable="true">
            <div class="dynajot-7843297729268670-foobar-5"></div>
        </div>
        <script src="data.js"></script>
        <script src="jquery.min.js"></script>
        <script>
            var playActions = function () {
                var valid_action_key = {
                    "position": true,
                    "children": true,
                    "create": true
                };
                var action, i, key, manode;

                var action_data = {};
                // create, read, update, delete
                action_data.count = data_JSON["actions"].length;
                var delay = 500;

                while (action_data.count--) {
                    setTimeout((function (i) {
                        return function () {
                            action = data_JSON["actions"][i];
                            $("#edits ul").append("<div>dynajot-"+action.id+"</div>");

                            if (action.attrs) {
                                // + or -  // TODO
                            }
                            if (action.create) {
                                // create, and maybe insert a new node
                                manode = action.create;
                                var newNode = document.createElement(manode.name);
                                newNode.className = manode.attrs["class"]; // manode.attrs -> hash;
                                if (manode.children.length > 0) {
                                    // newNode.appendChild(); // console.log("adding children");
                                }

                                if (manode.position) {
                                    var parent = document.body.querySelector(".dynajot-"+manode.position.parent);
                                    parent.insertBefore(newNode, parent.children[manode.position.index]); // handle the index properly?
                                }
                                // {
                                //     "create":
                                //     {
                                //         "attrs":{"class":"dynajot-7843297729268670-foobar-22"},
                                //         "name":"br",
                                //         "children":[],
                                //         "position":
                                //             {"parent":"7843297729268670-foobar-5","index":0}
                                //     }
                                // }
                            }
                            if (action.position) {
                                // move me - for text nodes (at this position, insert)
                                    // my position relative to the parent
                                    // console.log(dom_id);
                            }
                            if (action.children) {
                                // move somebody else
                                    // position for the children of this node
                                manode = document.body.querySelector(".dynajot-"+action.id);
                                
                                var start, end, kind, value, kount, newNode, child;
                                child = action.children[0];
                                start = child.start; // can be more than one child?
                                end = child.end;
                                kount = child.value.length;
                                while (kount--) {
                                    newNode = child.value[kount];
                                    if (newNode.kind === 'text') {
                                        // replace the range (start-end) with "value" nodes
                                        for (var l=start; l < end; l++) {
                                            // manode.
                                        }
                                        // alert(newNode.value);
                                        manode.innerHTML = newNode.value; // text - document.createTextNode
                                    } else if (newNode.kind === 'element') {
                                        // lookup the element by id
                                            // if already in the dom, remove & add as a child in this position
                                            // if not, skip the remove & add (insertBefore / insertAfter)
                                    }
                                }
                            }
                        }
                    })(action_data.count), delay);
                    delay += 100;
                }
            };

            playActions();
        </script>
    </body>
</html>
